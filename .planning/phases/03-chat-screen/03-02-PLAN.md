---
phase: 03-chat-screen
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/features/chat/presentation/screens/chat_screen.dart
  - lib/features/chat/presentation/widgets/chat_composer.dart
  - lib/features/chat/presentation/widgets/chat_empty_state.dart
autonomous: true

must_haves:
  truths:
    - "The chat screen displays a Chat widget with InMemoryChatController from the bridge provider"
    - "The custom composer is a floating rounded text field with send/stop toggle and auto-expanding input"
    - "The empty state shows a branded welcome message with 3 tappable suggestion chips"
    - "Tapping a suggestion chip sends that message immediately"
    - "While streaming, the input is disabled and shows a stop button instead of send"
    - "The chat auto-scrolls to bottom during streaming when user is near bottom, but stops if user scrolls up"
  artifacts:
    - path: "lib/features/chat/presentation/screens/chat_screen.dart"
      provides: "Full ChatScreen with Chat widget, custom builders, auto-scroll, and Riverpod integration"
      contains: "ChatScreen"
    - path: "lib/features/chat/presentation/widgets/chat_composer.dart"
      provides: "Custom composer with floating rounded input, send/stop, auto-expand"
      contains: "ChatComposer"
    - path: "lib/features/chat/presentation/widgets/chat_empty_state.dart"
      provides: "Welcome screen with LoglyAI branding and 3 suggestion chips"
      contains: "ChatEmptyState"
  key_links:
    - from: "lib/features/chat/presentation/screens/chat_screen.dart"
      to: "lib/features/chat/presentation/providers/chat_ui_provider.dart"
      via: "ref.watch(chatUiStateProvider)"
      pattern: "chatUiStateProvider"
    - from: "lib/features/chat/presentation/widgets/chat_composer.dart"
      to: "lib/features/chat/presentation/providers/chat_ui_provider.dart"
      via: "ref.read(chatUiStateProvider.notifier).sendMessage(text)"
      pattern: "sendMessage"
    - from: "lib/features/chat/presentation/screens/chat_screen.dart"
      to: "lib/features/chat/presentation/providers/chat_stream_provider.dart"
      via: "ref.listen(chatStreamStateProvider) for auto-scroll"
      pattern: "chatStreamStateProvider"
---

<objective>
Build the ChatScreen widget with the `flutter_chat_ui` Chat widget, custom composer with send/stop toggle, and empty state with welcome screen and suggestion chips.

Purpose: This is the main screen assembly -- connecting the bridge provider from Plan 01 to the `flutter_chat_ui` Chat widget, and providing the input and empty state UI that users interact with.

Output: A fully functional (but unstyled message) chat screen where users can type and send questions, see the Chat widget scaffold with messages, and interact with the composer and empty state.
</objective>

<execution_context>
@/Users/robsnider/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robsnider/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-chat-screen/03-CONTEXT.md
@.planning/phases/03-chat-screen/03-RESEARCH.md
@.planning/phases/03-chat-screen/03-01-SUMMARY.md

Key existing files to read before implementing:
@lib/features/chat/presentation/providers/chat_ui_provider.dart -- Bridge provider (from Plan 01)
@lib/features/chat/presentation/providers/chat_stream_provider.dart -- ChatStreamStateNotifier
@lib/features/chat/domain/chat_stream_state.dart -- ChatConnectionStatus enum
@lib/features/auth/presentation/providers/auth_state_provider.dart -- currentUserProvider

Key library source to reference:
- /Users/robsnider/.pub-cache/hosted/pub.dev/flutter_chat_ui-2.11.1/lib/src/chat.dart -- Chat widget API
- /Users/robsnider/.pub-cache/hosted/pub.dev/flutter_chat_ui-2.11.1/lib/src/composer.dart -- Default Composer (reference for height reporting)
- /Users/robsnider/.pub-cache/hosted/pub.dev/flutter_chat_ui-2.11.1/lib/src/utils/composer_height_notifier.dart -- ComposerHeightNotifier
- /Users/robsnider/.pub-cache/hosted/pub.dev/flutter_chat_core-2.9.0/lib/src/models/builders.dart -- Builder typedefs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Custom composer widget</name>
  <files>
    lib/features/chat/presentation/widgets/chat_composer.dart
  </files>
  <action>
    Create `lib/features/chat/presentation/widgets/chat_composer.dart`:

    A `ConsumerStatefulWidget` named `ChatComposer` that provides a floating rounded text input with send/stop button toggle.

    **Props:**
    - `onSendMessage`: `void Function(String query)` callback
    - `onStopStreaming`: `VoidCallback` callback
    - `initialText`: `String?` for restoring text after error (from `lastErrorQuery`)

    **State:**
    - `TextEditingController _textController`
    - `bool _hasText` (tracks whether input has content, for enabling/disabling send button)

    **initState:**
    - Initialize `_textController` with `initialText` if provided
    - Set `_hasText` based on initial text
    - Add listener to `_textController` to update `_hasText` on changes

    **dispose:**
    - Dispose `_textController`

    **Build logic:**
    - Watch `chatStreamStateProvider` to determine if streaming is active:
      ```dart
      final streamState = ref.watch(chatStreamStateProvider);
      final isStreaming = streamState.status == ChatConnectionStatus.streaming ||
                          streamState.status == ChatConnectionStatus.connecting ||
                          streamState.status == ChatConnectionStatus.completing;
      ```

    **CRITICAL: Composer height reporting (Pitfall 5 from research):**
    - The custom composer MUST report its height to `flutter_chat_ui`'s `ComposerHeightNotifier`.
    - Wrap the composer's outer widget in a `MeasuredWidget` pattern:
      - Use a `GlobalKey` on the outer Container
      - In `addPostFrameCallback` after build, measure height and call:
        `context.read<ComposerHeightNotifier>().setHeight(measuredHeight)`
      - This must happen on every build (since the text field auto-expands, height changes).
    - Import `ComposerHeightNotifier` from `package:flutter_chat_ui/src/utils/composer_height_notifier.dart` (or the internal path -- check the actual export).
    - Actually, check if `ComposerHeightNotifier` is exported. If not, use `Provider.of<ComposerHeightNotifier>(context)`. Read the `flutter_chat_ui` composer.dart to see how it reports height.

    **Layout:**
    ```
    SafeArea(
      child: Container(
        padding: EdgeInsets.fromLTRB(16, 8, 8, 8),
        decoration: BoxDecoration(
          color: theme.colorScheme.surface,
          border: Border(top: BorderSide(color: theme.colorScheme.outlineVariant, width: 0.5)),
        ),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Expanded(
              child: TextField(
                controller: _textController,
                enabled: !isStreaming,
                maxLines: 5,
                minLines: 1,
                textInputAction: TextInputAction.newline,
                decoration: InputDecoration(
                  hintText: isStreaming ? 'Waiting for response...' : 'Ask about your activities...',
                  filled: true,
                  fillColor: theme.colorScheme.surfaceContainerHighest,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(24),
                    borderSide: BorderSide.none,
                  ),
                  contentPadding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                ),
              ),
            ),
            SizedBox(width: 8),
            // Send or Stop button
            if (isStreaming)
              IconButton.filled(
                icon: Icon(LucideIcons.square, size: 18),
                onPressed: onStopStreaming,
                style: IconButton.styleFrom(
                  backgroundColor: theme.colorScheme.error,
                  foregroundColor: theme.colorScheme.onError,
                ),
              )
            else
              IconButton.filled(
                icon: Icon(LucideIcons.sendHorizontal, size: 18),
                onPressed: _hasText ? _handleSend : null,
                style: IconButton.styleFrom(
                  backgroundColor: _hasText ? theme.colorScheme.primary : theme.colorScheme.surfaceContainerHighest,
                  foregroundColor: _hasText ? theme.colorScheme.onPrimary : theme.colorScheme.onSurfaceVariant,
                ),
              ),
          ],
        ),
      ),
    )
    ```

    **_handleSend:**
    - Get text from controller, trim it
    - If empty, return
    - Call `widget.onSendMessage(text)`
    - Clear the text controller
    - Set `_hasText = false`

    **Note:** Do NOT make this widget a `const` constructor since it takes callback parameters.
  </action>
  <verify>
    - `fvm flutter analyze` passes clean
    - ChatComposer renders with TextField and send button
    - Send button disabled when text is empty
    - Stop button shows when streaming
  </verify>
  <done>
    Custom composer with floating rounded input, send/stop toggle, auto-expanding text field (1-5 lines), disabled during streaming with "Waiting for response..." placeholder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Empty state, ChatScreen assembly with Chat widget</name>
  <files>
    lib/features/chat/presentation/widgets/chat_empty_state.dart
    lib/features/chat/presentation/screens/chat_screen.dart
  </files>
  <action>
    **Part A: Create empty state widget**

    Create `lib/features/chat/presentation/widgets/chat_empty_state.dart`:

    A `StatelessWidget` named `ChatEmptyState` with a welcome screen and suggestion chips.

    **Props:**
    - `onSuggestionTap`: `void Function(String question)` callback

    **Layout:**
    ```
    Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: 32),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // LoglyAI icon
            Container(
              width: 64, height: 64,
              decoration: BoxDecoration(
                color: theme.colorScheme.primaryContainer,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(LucideIcons.sparkles, size: 32, color: theme.colorScheme.onPrimaryContainer),
            ),
            SizedBox(height: 16),
            // Welcome title
            Text('LoglyAI', style: theme.textTheme.headlineSmall?.copyWith(fontWeight: FontWeight.bold)),
            SizedBox(height: 8),
            // Welcome subtitle
            Text(
              'Ask me anything about your activities and habits',
              style: theme.textTheme.bodyMedium?.copyWith(color: theme.colorScheme.onSurfaceVariant),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 24),
            // Suggestion chips
            Wrap(
              spacing: 8,
              runSpacing: 8,
              alignment: WrapAlignment.center,
              children: [
                _SuggestionChip(
                  label: 'What did I do this week?',
                  onTap: () => onSuggestionTap('What did I do this week?'),
                ),
                _SuggestionChip(
                  label: 'What are my most consistent habits?',
                  onTap: () => onSuggestionTap('What are my most consistent habits?'),
                ),
                _SuggestionChip(
                  label: 'How active was I last month?',
                  onTap: () => onSuggestionTap('How active was I last month?'),
                ),
              ],
            ),
            // Bottom padding so chips aren't hidden behind composer
            SizedBox(height: 80),
          ],
        ),
      ),
    )
    ```

    **_SuggestionChip:**
    A private `StatelessWidget`:
    ```
    ActionChip(
      label: Text(label),
      onPressed: onTap,
      avatar: Icon(LucideIcons.messageSquare, size: 16),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
    )
    ```

    **Part B: Replace ChatScreen placeholder with full implementation**

    Rewrite `lib/features/chat/presentation/screens/chat_screen.dart`:

    A `ConsumerStatefulWidget` named `ChatScreen`.

    **Build:**
    ```dart
    @override
    Widget build(BuildContext context) {
      final controller = ref.watch(chatUiStateProvider);
      final currentUser = ref.watch(currentUserProvider);
      final userId = currentUser?.id ?? 'anonymous';
      final theme = Theme.of(context);

      // Check for error query restoration
      final lastErrorQuery = ref.read(chatUiStateProvider.notifier).lastErrorQuery;

      return Scaffold(
        appBar: AppBar(
          title: const Text('LoglyAI'),
          centerTitle: false,
        ),
        body: Chat(
          currentUserId: userId,
          resolveUser: (id) async => User(id: id),
          chatController: controller,
          theme: ChatTheme.fromThemeData(theme),
          builders: Builders(
            composerBuilder: (_) => ChatComposer(
              onSendMessage: _handleSendMessage,
              onStopStreaming: _handleStopStreaming,
              initialText: lastErrorQuery,
            ),
            emptyChatListBuilder: (_) => ChatEmptyState(
              onSuggestionTap: _handleSendMessage,
            ),
            chatMessageBuilder: _buildChatMessage,
            textMessageBuilder: _buildTextMessage,
            textStreamMessageBuilder: _buildTextStreamMessage,
            systemMessageBuilder: _buildSystemMessage,
          ),
        ),
      );
    }
    ```

    **_handleSendMessage(String query):**
    ```dart
    void _handleSendMessage(String query) {
      ref.read(chatUiStateProvider.notifier).clearLastErrorQuery();
      ref.read(chatUiStateProvider.notifier).sendMessage(query);
    }
    ```

    **_handleStopStreaming():**
    ```dart
    void _handleStopStreaming() {
      ref.read(chatStreamStateProvider.notifier).cancelStream();
    }
    ```

    **Builder stubs (to be fully implemented in Plan 03):**

    `_buildChatMessage`: Override to remove bubble styling. Make all messages full-width, left-aligned:
    ```dart
    Widget _buildChatMessage(
      BuildContext context,
      Message message,
      int index,
      Animation<double> animation,
      Widget child, {
      bool? isRemoved,
      required bool isSentByMe,
      MessageGroupStatus? groupStatus,
    }) {
      return SizeTransition(
        sizeFactor: animation,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
          child: child,
        ),
      );
    }
    ```

    `_buildTextMessage`: User messages in flat card, AI messages plain:
    ```dart
    Widget _buildTextMessage(
      BuildContext context,
      TextMessage message,
      int index, {
      required bool isSentByMe,
      MessageGroupStatus? groupStatus,
    }) {
      final theme = Theme.of(context);
      if (isSentByMe) {
        return Card(
          elevation: 0,
          color: theme.colorScheme.surfaceContainerHighest,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            child: Text(message.text, style: theme.textTheme.bodyMedium),
          ),
        );
      }
      // AI completed message -- render with GptMarkdown
      return Padding(
        padding: const EdgeInsets.symmetric(vertical: 4),
        child: GptMarkdown(
          message.text,
          style: theme.textTheme.bodyLarge,
        ),
      );
    }
    ```

    `_buildTextStreamMessage`: Streaming AI message with step progress + streaming text. This is a stub that Plan 03 will enhance with the step progress widget:
    ```dart
    Widget _buildTextStreamMessage(
      BuildContext context,
      TextStreamMessage message,
      int index, {
      required bool isSentByMe,
      MessageGroupStatus? groupStatus,
    }) {
      final streamState = ref.watch(chatStreamStateProvider);
      final theme = Theme.of(context);

      // Map ChatStreamState to package StreamState
      final packageStreamState = _mapStreamState(streamState);

      return Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Step progress placeholder -- Plan 03 will replace with StepProgressWidget
          _buildStepProgress(message.metadata, theme),
          // Streaming text
          FlyerChatTextStreamMessage(
            message: message,
            index: index,
            streamState: packageStreamState,
            mode: TextStreamMessageMode.instantMarkdown,
            padding: const EdgeInsets.symmetric(vertical: 4),
            borderRadius: BorderRadius.zero,
            receivedBackgroundColor: Colors.transparent,
            receivedTextStyle: theme.textTheme.bodyLarge,
            showTime: false,
            showStatus: false,
          ),
        ],
      );
    }
    ```

    `_mapStreamState` helper:
    ```dart
    StreamState _mapStreamState(ChatStreamState state) {
      return switch (state.status) {
        ChatConnectionStatus.idle => const StreamStateLoading(),
        ChatConnectionStatus.connecting => const StreamStateLoading(),
        ChatConnectionStatus.streaming => StreamStateStreaming(state.displayText),
        ChatConnectionStatus.completing => StreamStateStreaming(state.displayText),
        ChatConnectionStatus.completed => StreamStateCompleted(state.fullText),
        ChatConnectionStatus.error => StreamStateError(
            state.errorMessage ?? 'Something went wrong',
            accumulatedText: state.displayText.isNotEmpty ? state.displayText : null,
          ),
      };
    }
    ```

    `_buildStepProgress` inline helper (simplified -- Plan 03 extracts to widget):
    ```dart
    Widget _buildStepProgress(Map<String, dynamic>? metadata, ThemeData theme) {
      if (metadata == null) return const SizedBox.shrink();

      final steps = (metadata['steps'] as List<dynamic>?)?.cast<String>() ?? [];
      final currentStepName = metadata['currentStepName'] as String?;
      final currentStepStatus = metadata['currentStepStatus'] as String?;
      final stepsCollapsed = metadata['stepsCollapsed'] as bool? ?? false;
      final stepDurationMs = metadata['stepDurationMs'] as int?;

      if (steps.isEmpty && currentStepName == null) return const SizedBox.shrink();

      if (stepsCollapsed) {
        final duration = stepDurationMs != null ? (stepDurationMs / 1000).toStringAsFixed(1) : '?';
        return Padding(
          padding: const EdgeInsets.only(bottom: 8),
          child: Text(
            'Processed in ${steps.length} steps (${duration}s)',
            style: theme.textTheme.bodySmall?.copyWith(color: theme.colorScheme.onSurfaceVariant),
          ),
        );
      }

      return Padding(
        padding: const EdgeInsets.only(bottom: 8),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            for (final step in steps)
              Padding(
                padding: const EdgeInsets.symmetric(vertical: 2),
                child: Row(
                  children: [
                    Icon(LucideIcons.check, size: 14, color: theme.colorScheme.primary),
                    const SizedBox(width: 8),
                    Text(step, style: theme.textTheme.bodySmall),
                  ],
                ),
              ),
            if (currentStepName != null && currentStepStatus == 'start')
              Padding(
                padding: const EdgeInsets.symmetric(vertical: 2),
                child: Row(
                  children: [
                    SizedBox(
                      width: 14, height: 14,
                      child: CircularProgressIndicator(strokeWidth: 2, color: theme.colorScheme.primary),
                    ),
                    const SizedBox(width: 8),
                    Text(currentStepName, style: theme.textTheme.bodySmall),
                  ],
                ),
              ),
          ],
        ),
      );
    }
    ```

    `_buildSystemMessage`: For error messages:
    ```dart
    Widget _buildSystemMessage(
      BuildContext context,
      SystemMessage message,
      int index, {
      required bool isSentByMe,
      MessageGroupStatus? groupStatus,
    }) {
      final theme = Theme.of(context);
      return Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: theme.colorScheme.errorContainer,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          children: [
            Icon(LucideIcons.alertCircle, size: 18, color: theme.colorScheme.onErrorContainer),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                message.text,
                style: theme.textTheme.bodyMedium?.copyWith(color: theme.colorScheme.onErrorContainer),
              ),
            ),
          ],
        ),
      );
    }
    ```

    **Imports needed:**
    - `flutter_chat_core` (Chat, Builders, Message types, User, ChatTheme, InMemoryChatController, MessageGroupStatus)
    - `flutter_chat_ui` (Chat)
    - `flyer_chat_text_stream_message` (FlyerChatTextStreamMessage, StreamState, TextStreamMessageMode)
    - `gpt_markdown` (GptMarkdown)
    - `lucide_icons_flutter`
    - `flutter_riverpod`
    - chat providers (chatUiStateProvider, chatStreamStateProvider)
    - auth provider (currentUserProvider)
    - local widgets (ChatComposer, ChatEmptyState)
  </action>
  <verify>
    - `fvm flutter analyze` passes clean
    - ChatScreen builds without runtime errors
    - Empty state renders with welcome message and 3 suggestion chips
    - Tapping a chip calls sendMessage
    - Composer shows send/stop toggle based on stream state
    - Messages appear in the chat list when sent
  </verify>
  <done>
    Full ChatScreen with Chat widget integration, custom composer with send/stop, empty state with suggestions, flat message layout (user cards, AI plain), streaming text with GptMarkdown, step progress inline, and error messages styled. All builders wired.
  </done>
</task>

</tasks>

<verification>
1. `fvm flutter analyze` -- zero errors, zero warnings
2. Chat screen renders the Chat widget connected to the bridge provider's InMemoryChatController
3. Empty state shows on fresh screen with 3 suggestion chips
4. Sending a message (via input or chip) inserts user message + AI stream placeholder
5. Streaming text renders via FlyerChatTextStreamMessage with GptMarkdown
6. Step progress shows inline above streaming text
7. Composer disables during streaming with stop button
8. Error messages appear inline styled as error container
</verification>

<success_criteria>
- User can type a question and see it appear as a flat card message
- AI response streams token-by-token with markdown rendering
- Step progress shows spinners during processing, checkmarks when done, collapses to summary
- Empty state with suggestion chips is fully interactive
- Composer send/stop toggle works correctly
- Error messages are styled inline without technical details
</success_criteria>

<output>
After completion, create `.planning/phases/03-chat-screen/03-02-SUMMARY.md`
</output>
